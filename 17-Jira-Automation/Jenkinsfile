// pipeline {
//   agent any

//   parameters {
//     choice( name: 'PROJECT',     choices: ['System Team - Platform Engineering (STPE)'],    description: 'Please enter the Project name')
//     choice( name: 'Issue Type',  choices: ['Story'],                                      description: 'Enter the Issue type')
//     string( name: 'Summary',     defaultValue: '',                                        description: 'Issue Summary')
//     choice( name: 'Assignee',    choices: ['Abhishek Alimchandani','Vandan Banda'],      description: 'Select the Assignee')
//     choice( name: 'Reporter',    choices: ['Tammy Reid'],                                  description: 'Select the Reporter')
//     choice( name: 'Epic Link',   choices: ['Jenkins Stabilization & Performance Enhancements'], description: 'Enter the Epic Link')
//     string( name: 'Description', defaultValue: '',                                        description: 'Enter the Story description')
//   }

//   environment {
//     JIRA_BASE_URL = 'https://abhishekalimchandani1624.atlassian.net'
//     JIRA_USER     = 'abhishekalimchandani1624@gmail.com'
//     // Store your API token as a Secret Text credential with ID 'jira-api-token-id'
//     JIRA_TOKEN    = credentials('jira-api-token-id')
//   }

//   stages {
//     stage('Create Jira Story') {
//       steps {
//         script {
//           // 1) cd into the folder containing both Jenkinsfile & helper
//           dir('17-Jira-Automation') {
//             // 2) load the helper; this gives you an object with createJiraStory()
//             def jira = load 'jiraUtil.groovy'

//             // 3) call the helper method on that object
//             def story = jira.createJiraStory(
//               env.JIRA_BASE_URL,
//               env.JIRA_USER,
//               env.JIRA_TOKEN,
//               params.PROJECT,
//               params['Issue Type'],
//               params.Summary,
//               params.Assignee,
//               params.Reporter,
//               params['Epic Link'],
//               params.Description
//             )

//             // 4) confirm in console
//             echo "âœ… Created JIRA Story ${story.key}"
//             echo "ðŸ”— URL: ${story.self}"
//           }
//         }
//       }
//     }
//   }
// }

pipeline {
  agent any

  parameters {
    choice( name: 'PROJECT',     choices: ['System Team - Platform Engineering (STPE)'],     description: 'Please enter the Project name' )
    choice( name: 'Issue Type',  choices: ['Story'],                                       description: 'Enter the Issue type' )
    string( name: 'Summary',     defaultValue: '',                                         description: 'Issue Summary' )
    choice( name: 'Assignee',    choices: ['Abhishek Alimchandani','Vandan Banda'],       description: 'Select the Assignee' )
    choice( name: 'Reporter',    choices: ['Tammy Reid'],                                  description: 'Select the Reporter' )
    choice( name: 'Epic Link',   choices: ['Jenkins Stabilization & Performance Enhancements'], description: 'Enter the Epic Link' )
    string( name: 'Description', defaultValue: '',                                         description: 'Enter the Story description' )
  }

  environment {
    JIRA_BASE_URL = 'https://abhishekalimchandani1624.atlassian.net'
    JIRA_USER     = 'abhishekalimchandani1624@gmail.com'
    // Secret text credential containing your API token
    JIRA_TOKEN    = credentials('jira-api-token-id')
  }

  stages {
    stage('Create Jira Story') {
      steps {
        script {
          // 1) Build the JSON payload as a Groovy map
          def payload = [
            fields: [
              project          : [ key: params.PROJECT ],
              issuetype        : [ name: params['Issue Type'] ],
              summary          : params.Summary,
              description      : params.Description,
              assignee         : [ name: params.Assignee ],
              reporter         : [ name: params.Reporter ],
              customfield_10008: params['Epic Link']
            ]
          ]

          // 2) Serialize to JSON text
          def jsonBody = groovy.json.JsonOutput.toJson(payload)

          // 3) Write it to a temporary file in the workspace
          writeFile file: 'jira_payload.json', text: jsonBody

          // 4) Call JIRA via curl (shell step)
          //    -s: silent, -u: basic auth, -H: header, -d: @file
          def response = sh(
            script: """
              curl -s -X POST \\
                -H "Content-Type: application/json" \\
                -u "${env.JIRA_USER}:${env.JIRA_TOKEN}" \\
                -d @jira_payload.json \\
                "${env.JIRA_BASE_URL}/rest/api/2/issue"
            """,
            returnStdout: true
          ).trim()

          // 5) Parse the JSON response with JsonSlurper
          def json = new groovy.json.JsonSlurper().parseText(response)

          // 6) Output the new issue key and URL
          echo "âœ… Created JIRA Story ${json.key}"
          echo "ðŸ”— ${json.self}"
        }
      }
    }
  }
}
