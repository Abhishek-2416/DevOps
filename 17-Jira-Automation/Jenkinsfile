pipeline {
  agent any

  parameters {
    choice( name: 'PROJECT',     choices: ['System Team - Platform Engineering (STPE)'],    description: 'Select the Project (key in parentheses)' )
    choice( name: 'Issue Type',  choices: ['Story'],                                      description: 'Enter the Issue Type' )
    string( name: 'Summary',     defaultValue: '',                                         description: 'Story Summary' )
    choice( name: 'Assignee',    choices: ['Abhishek Alimchandani','Vandan Banda'],       description: 'Select the Assignee' )
    choice( name: 'Reporter',    choices: ['Tammy Reid'],                                  description: 'Select the Reporter' )
    choice( name: 'Epic Link',   choices: ['Jenkins Stabilization & Performance Enhancements'], description: 'Enter the Epic Link Key' )
    string( name: 'Description', defaultValue: '',                                         description: 'Enter the Story Description' )
  }

  environment {
    // Must match the ‚ÄúName‚Äù configured in Manage Jenkins ‚Üí Configure System ‚Üí JIRA Sites
    JIRA_SITE = 'MYJIRA'
  }

  stages {
    stage('Create and Assign Jira Story') {
      steps {
        script {
          // 1) Extract the JIRA key from the display string:
          def raw = params.PROJECT
          def key = raw.replaceAll(/^.*\((.*)\)$/, '$1')
          echo "Using project key: ${key}"

          // 2) Create the story via direct parameters:
          def issueKey = jiraNewIssue(
            site       : JIRA_SITE,
            projectKey : key,
            issueType  : params['Issue Type'],
            summary    : params.Summary,
            description: params.Description,
            reporter   : params.Reporter,
            assignee   : params.Assignee,
            customfields: [[ id: 'customfield_10008', value: params['Epic Link'] ]]
          )
          echo "‚úÖ Created JIRA Story ${issueKey}"

          // 3) Assign the issue (in case the create step didn‚Äôt respect assignee):
          jiraAssignIssue(
            site    : JIRA_SITE,
            issueKey: issueKey,
            assignee: params.Assignee
          )
          echo "üë§ Assigned to ${params.Assignee}"

          // 4) Print the browse URL:
          echo "üîó https://abhishekalimchandani1624.atlassian.net/browse/${issueKey}"
        }
      }
    }
  }
}
