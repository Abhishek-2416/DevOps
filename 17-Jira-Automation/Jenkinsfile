stage('Create and Assign Jira Story') {
  steps {
    script {
      // 1) Extract the JIRA key
      def raw = params.PROJECT
      def projKey = raw.replaceAll(/^.*\((.*)\)$/, '$1')
      echo "Using project key: ${projKey}"

      // 2) Build the inner fields map exactly as the REST API wants
      def fieldsMap = [
        project          : [ key: projKey ],
        issuetype        : [ name: params['Issue Type'] ],
        summary          : params.Summary,
        description      : params.Description,
        assignee         : [ name: params.Assignee ],
        reporter         : [ name: params.Reporter ],
        customfield_10008: params['Epic Link']
      ]

      // 3) Wrap it in the `issue: [ fields: â€¦ ]` envelope
      def issuePayload = [ fields: fieldsMap ]

      // 4) Call jiraNewIssue with the nested payload
      def issueKey = jiraNewIssue(
        site : 'MYJIRA',
        issue: issuePayload
      )
      echo "âœ… Created JIRA Story ${issueKey}"

      // 5) Assign just in case
      jiraAssignIssue(
        site    : 'MYJIRA',
        issueKey: issueKey,
        assignee: params.Assignee
      )
      echo "ðŸ‘¤ Assigned to ${params.Assignee}"

      // 6) Print URL
      echo "ðŸ”— https://abhishekalimchandani1624.atlassian.net/browse/${issueKey}"
    }
  }
}
