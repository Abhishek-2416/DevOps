import groovy.json.JsonOutput
import groovy.json.JsonSlurper

pipeline {
  agent any

  parameters {
    choice( name: 'PROJECT',     choices: ['System Team - Platform Engineering (STPE)'],     description: 'Select the Project (key in parentheses)' )
    choice( name: 'Issue Type',  choices: ['Story'],                                      description: 'Enter the Issue Type' )
    string( name: 'Summary',     defaultValue: '',                                         description: 'Story Summary' )
    choice( name: 'Assignee',    choices: ['Abhishek Alimchandani','Vandan Banda'],       description: 'Select the Assignee' )
    choice( name: 'Reporter',    choices: ['Tammy Reid'],                                  description: 'Select the Reporter' )
    choice( name: 'Epic Link',   choices: ['Jenkins Stabilization & Performance Enhancements'], description: 'Enter the Epic Link Key' )
    string( name: 'Description', defaultValue: '',                                         description: 'Enter the Story Description' )
  }

  environment {
    JIRA_SITE = 'MYJIRA'  // must match the ‚ÄúName‚Äù in Manage Jenkins ‚Üí Configure System ‚Üí JIRA Sites
  }

  stages {
    stage('Create and Assign Jira Story') {
      steps {
        script {
          // 1) Pull out the real project key (e.g. "STPE")
          def raw    = params.PROJECT
          def projKey= raw.replaceAll(/^.*\((.*)\)$/, '$1')
          echo "Using project key: ${projKey}"

          // 2) Build the JIRA fields map
          def fieldsMap = [
            project          : [ key: projKey ],
            issuetype        : [ name: params['Issue Type'] ],
            summary          : params.Summary,
            description      : params.Description,
            reporter         : params.Reporter,
            assignee         : params.Assignee,
            customfield_10008: params['Epic Link']
          ]

          // 3) Wrap it in the 'issue' envelope
          def issuePayload = [ fields: fieldsMap ]

          // 4) Create the JIRA story
          def issueKey = jiraNewIssue(
            site : env.JIRA_SITE,
            issue: issuePayload
          )
          echo "‚úÖ Created JIRA Story ${issueKey}"

          // 5) Assign it explicitly (just to be sure)
          jiraAssignIssue(
            site    : env.JIRA_SITE,
            issueKey: issueKey,
            assignee: params.Assignee
          )
          echo "üë§ Assigned to ${params.Assignee}"

          // 6) Print the browse URL
          echo "üîó https://abhishekalimchandani1624.atlassian.net/browse/${issueKey}"
        }
      }
    }
  }
}
